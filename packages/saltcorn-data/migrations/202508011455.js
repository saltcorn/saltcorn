const js = async () => {
  const Table = require("../models/table");
  const Field = require("../models/field");
  const File = require("../models/file");
  const Page = require("../models/page");
  const View = require("../models/view");
  const Plugin = require("../models/plugin");
  const { traverseSync } = require("../models/layout");

  const db = require("../db");
  const tables = await Table.find({});
  const fsp = require("fs").promises;
  const fs = require("fs");
  const path = require("path");
  const { getState } = require("../db/state");

  await File.ensure_file_store(db.getTenantSchema());

  const state = getState();
  await state?.refresh_tables(false);
  await state?.refresh_views(false);
  await state?.refresh_triggers(false);
  await state?.refresh_pages(false);
  await state?.refresh_config(false);
  await state?.refresh_npmpkgs(false);
  const allow_signup = state.getConfig("allow_signup");
  const notification_in_menu = state.getConfig("notification_in_menu");
  const login_menu = state.getConfig("login_menu");
  const new_items = [
    {
      href: "",
      icon: "bi bi-table",
      text: "Tables",
      type: "Admin Page",
      label: "Tables",
      style: "",
      title: "",
      target: "_self",
      tooltip: "",
      in_modal: false,
      location: "Standard",
      max_role: "1",
      min_role: "1",
      admin_page: "Tables",
      target_blank: false,
      disable_on_mobile: false,
    },
    {
      href: "",
      icon: "fas fa-eye",
      text: "Views",
      type: "Admin Page",
      label: "Views",
      style: "",
      title: "",
      target: "_self",
      tooltip: "",
      in_modal: false,
      location: "Standard",
      max_role: "1",
      min_role: "1",
      admin_page: "Views",
      target_blank: false,
      disable_on_mobile: false,
    },
    {
      href: "",
      icon: "far fa-file",
      text: "Pages",
      type: "Admin Page",
      label: "Pages",
      style: "",
      title: "",
      target: "_self",
      tooltip: "",
      in_modal: false,
      location: "Standard",
      max_role: "1",
      min_role: "1",
      admin_page: "Pages",
      target_blank: false,
      disable_on_mobile: false,
    },
    {
      href: "",
      icon: "fas fa-wrench",
      text: "Settings",
      type: "Header",
      label: "Settings",
      style: "",
      title: "",
      target: "_self",
      tooltip: "",
      location: "Standard",
      max_role: "1",
      min_role: "1",
      subitems: [
        {
          href: "",
          icon: "bi bi-tools",
          text: "About application",
          type: "Admin Page",
          label: "About application",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "About application",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-cubes",
          text: "Modules",
          type: "Admin Page",
          label: "Modules",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "Modules",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-users-cog",
          text: "Users and security",
          type: "Admin Page",
          label: "Users and security",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "Users and security",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-compass",
          text: "Site structure",
          type: "Admin Page",
          label: "Site structure",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "Site structure",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-images",
          text: "Files",
          type: "Admin Page",
          label: "Files",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "Files",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-calendar-check",
          text: "Events",
          type: "Admin Page",
          label: "Events",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "1",
          admin_page: "Events",
          target_blank: false,
          disable_on_mobile: false,
        },
      ],
      user_menu_header: false,
      disable_on_mobile: false,
    },
    ...(allow_signup
      ? [
          {
            href: "",
            icon: "fas fa-user-plus",
            text: "Signup",
            type: "User Page",
            label: "Signup",
            style: "",
            title: "",
            target: "_self",
            tooltip: "",
            in_modal: false,
            location: "Standard",
            max_role: "100",
            min_role: "100",
            user_page: "Signup",
            target_blank: false,
            disable_on_mobile: false,
          },
        ]
      : []),
    ...(login_menu
      ? [
          {
            href: "",
            icon: "fas fa-sign-in-alt",
            text: "Login",
            type: "User Page",
            label: "Login",
            style: "",
            title: "",
            target: "_self",
            tooltip: "",
            in_modal: false,
            location: "Standard",
            max_role: "100",
            min_role: "100",
            user_page: "Login",
            target_blank: false,
            disable_on_mobile: false,
          },
        ]
      : []),
    {
      href: "",
      icon: "far fa-user",
      text: "User",
      type: "Header",
      label: "User",
      style: "",
      title: "",
      target: "_self",
      tooltip: "",
      in_modal: false,
      location: "Standard",
      max_role: "1",
      min_role: "80",
      subitems: [
        notification_in_menu
          ? [
              {
                href: "",
                icon: "far fa-bell",
                text: "Notifications",
                type: "User Page",
                label: "Notifications",
                style: "",
                title: "",
                target: "_self",
                tooltip: "",
                in_modal: false,
                location: "Standard",
                max_role: "1",
                min_role: "80",
                user_page: "Notifications",
                target_blank: false,
                disable_on_mobile: false,
              },
            ]
          : [],
        {
          href: "",
          icon: "fas fa-user-cog",
          text: "User settings",
          type: "User Page",
          label: "User settings",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "80",
          user_page: "User settings",
          target_blank: false,
          disable_on_mobile: false,
        },
        {
          href: "",
          icon: "fas fa-sign-out-alt",
          text: "Logout",
          type: "User Page",
          label: "Logout",
          style: "",
          title: "",
          target: "_self",
          tooltip: "",
          in_modal: false,
          location: "Standard",
          max_role: "1",
          min_role: "80",
          user_page: "Logout",
          target_blank: false,
          disable_on_mobile: false,
        },
      ],
      user_menu_header: true,
      disable_on_mobile: false,
    },
  ];

  const menu = state.getConfigCopy("menu_items") || [];
  await state.setConfig("menu_items", [...menu, ...new_items]);
  const unrolled_menu = state.getConfigCopy("unrolled_menu_items") || [];
  await state.setConfig("unrolled_menu_items", [
    ...unrolled_menu,
    ...new_items,
  ]);
};

module.exports = { js };
